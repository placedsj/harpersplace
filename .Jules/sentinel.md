## 2024-05-22 - Strict CORS with REPLIT_DOMAINS
**Vulnerability:** The custom Express server was configured with `cors({ origin: true, credentials: true })`, allowing any site to make authenticated requests.
**Learning:** In Replit/Next.js custom server setups, `REPLIT_DOMAINS` is the source of truth for allowed origins. However, for local development, fallback to `localhost` is critical. Trailing slash inconsistencies between config and Origin headers must be normalized. `package-lock.json` stability is critical; inadvertent upgrades during debugging can break builds. `tsconfig.json` must exclude server/test directories to prevent Next.js from attempting to bundle them.
**Prevention:** Use the `createCorsOriginCheck` helper in `server/security.ts`. Exclude `server` and `tests` in `tsconfig.json`. Always run `npm run build` locally to catch duplicate import errors that only manifest during production builds.
