## 2024-05-22 - Strict CORS with REPLIT_DOMAINS
**Vulnerability:** The custom Express server was configured with `cors({ origin: true, credentials: true })`, allowing any site to make authenticated requests.
**Learning:** In Replit/Next.js custom server setups, `REPLIT_DOMAINS` is the source of truth for allowed origins. However, for local development, fallback to `localhost` is critical. Trailing slash inconsistencies between config and Origin headers must be normalized. `package-lock.json` stability is critical; inadvertent upgrades during debugging can break builds. Duplicate imports in pages can cause obscure "Pages changed" build failures in CI even if dev server works.
**Prevention:** Use the `createCorsOriginCheck` helper in `server/security.ts`. Always run `npm run build` locally to catch duplicate import errors that only manifest during production builds.
